---
title: "User Defined"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{User Defined}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r knit-options, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  cache = TRUE
)
```
# Three steps to your own model

To define your own DML procedure, you need to do three things:

1. Define your model specifications (using `parsnip`)
1. Define your own recipes (using `recipes`)
1. Run the DML procedure (using `run_dml()`)

## 1. Define your model specs

We define these using the `parsnip` package. There are literally thousands of available models, see the [parsnip documentation](https://parsnip.tidymodels.org/) for a comprehensive list and examples.

```{r pars-spec, warnings=FALSE, message=FALSE}
library(tiDML)

# Test dml_rf
df = diamonds_sample(n=500, seed=123)

# parsnip model spec 
g_spec = parsnip::rand_forest(trees = 100) |>
  parsnip::set_engine("ranger") |>
  parsnip::set_mode("regression")

m_spec = parsnip::rand_forest(trees = 100) |>
  parsnip::set_engine("ranger") |>
  parsnip::set_mode("classification")

```

## 2. Define your own recipes

```{r rec-specs, warnings=FALSE, message=FALSE}

g_rec <- recipes::recipe(price ~ carat + depth + table + x + y + z, data = df) |>
  recipes::step_log('carat') |> # Take log for a given column name
  recipes::step_impute_knn(recipes::all_numeric_predictors()) |> # Impute missing values for all numeric columns
  recipes::step_dummy(recipes::all_nominal(), -recipes::all_outcomes()) # Note the exclusion of outcome variables with -

m_rec <- recipes::recipe(is_rated_ideal ~ carat + depth + table + x + y + z, data = df) |>
  recipes::step_ns(carat, deg_free = 3) |>
  recipes::step_dummy(recipes::all_nominal(), -recipes::all_outcomes())
```

## Finally, run the DML procedure

Use the model specs and recipes defined above as inputs to `run_dml()`. Not the dataframe going into `run_dml()` must be the same as the one used to define the recipes.

```{r combine-to-run}
fit <- run_dml(
  data = df,
  outcome_recipe = g_rec,
  treatment_recipe = m_rec,
  outcome_model = g_spec,
  treatment_model = m_spec,
)
```