---
title: "Package Replication"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{package-replication}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(tiDML)
library(dplyr)
library(purrr)
library(tibble)
library(ggplot2)
library(DoubleML)
library(mlr3)
library(mlr3learners)
```


```{r run-comparison}
## ---- setup, message=FALSE, warning=FALSE --------------------------------

# Data and columns (keep instrument = FALSE for PLR)
df401k <- DoubleML::fetch_401k(return_type = "data.frame", instrument = FALSE)

y_col <- "net_tfa"
d_col <- "e401"
x_cols <- c("age","inc","educ","fsize","marr","twoearn","db","pira","hown")

# A single replicate runner with *explicit* args ----------------------------
run_rep <- function(seed, df, y, d, x, grid_trees = 1200L, n_folds = 5L) {
  set.seed(seed)

  ## tiDML :: dml_plr
  fit_tidml <- dml_plr(
    data = df,
    y = !!rlang::sym(y_col),
    d = !!rlang::sym(d_col),
    x = x_cols,
    m_model = "rf",
    g_model = "rf",
    grid_size = list(m = 15, g = 15)
  )
  tidml_row <- tibble(
    method = "tiDML",
    seed = seed,
    theta = unname(fit_tidml$theta),
    se    = unname(fit_tidml$se)
  ) |>
    mutate(
      lwr = theta - qnorm(0.975) * se,
      upr = theta + qnorm(0.975) * se
    )

  ## DoubleML :: PLR with ranger
  ml_l <- lrn("regr.ranger",
              num.trees = grid_trees, num.threads = 1,
              respect.unordered.factors = "order")
  ml_m <- lrn("regr.ranger",
            num.trees = 1200, num.threads = 1,
            respect.unordered.factors = "order")

  dml_data <- DoubleMLData$new(
    data = df, y_col = y, d_cols = d, x_cols = x
  )
  dml <- DoubleMLPLR$new(
    dml_data, ml_l = ml_l, ml_m = ml_m,
    n_folds = n_folds, score = "partialling out"
  )
  dml$fit()

  ci <- dml$confint(level = 0.95)
  dml_row <- tibble(
    method = "DoubleML",
    seed = seed,
    theta = as.numeric(dml$coef),
    se    = as.numeric(dml$se),
    lwr   = as.numeric(ci[1]),
    upr   = as.numeric(ci[2])
  )

  bind_rows(tidml_row, dml_row)
}

# Replications --------------------------------------------------------------

replications <- 2L

# Keep this small for CRAN; bump locally
seeds <- 401 + 0:replications-1  # 10 reps for vignette speed
res <- map_dfr(
  seeds,
  ~ run_rep(.x, df = df401k, y = y_col, d = d_col, x = x_cols)
)

# Overlap share per replication
overlap_by_seed <- res |>
  group_by(seed) |>
  summarise(
    min_upr = min(upr),
    max_lwr = max(lwr),
    overlap = max_lwr <= min_upr,
    .groups = "drop"
  )
mean_overlap <- mean(overlap_by_seed$overlap)

# Method-by-method densities
ggplot(res, aes(theta, fill = method)) +
  geom_density(alpha = 0.35) +
  labs(
    title = "DML-PLR estimates across seeds",
    subtitle = sprintf("Share of overlapping 95%% CIs: %.1f%%", 100 * mean_overlap),
    x = expression(hat(theta)), y = "Density", fill = "Method"
  ) +
  theme_minimal(base_size = 12)

# First N seeds: side-by-side CIs (“dumbbells”)
N <- min(replications, length(seeds))
plot_df <- res |>
  filter(seed %in% head(unique(seed), N))

ggplot(plot_df, aes(y = factor(seed), x = theta, color = method)) +
  geom_point(position = position_dodge(width = 0.4)) +
  geom_errorbarh(aes(xmin = lwr, xmax = upr),
                 height = 0, position = position_dodge(width = 0.4)) +
  labs(
    title = sprintf("95%% CIs by replication (first %d seeds)", N),
    x = expression(hat(theta)~"with 95% CI"), y = "Seed", color = "Method"
  ) +
  theme_minimal(base_size = 12)

# Scatter: tiDML vs DoubleML (y = x is perfect agreement)
scatter_df <- res |>
  select(seed, method, theta) |>
  tidyr::pivot_wider(names_from = method, values_from = theta)

ggplot(scatter_df, aes(DoubleML, tiDML)) +
  geom_abline(linetype = "dashed") +
  geom_point(alpha = 0.7) +
  labs(title = "Agreement of point estimates",
       x = "DoubleML θ", y = "tiDML θ") +
  theme_minimal(base_size = 12)

```